<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>每日学习助手 - AI 智能学习内容推荐</title>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
			rel="stylesheet"
		/>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			:root {
				--primary: #6366f1;
				--primary-dark: #4f46e5;
				--secondary: #8b5cf6;
				--accent: #06b6d4;
				--success: #10b981;
				--warning: #f59e0b;
				--error: #ef4444;

				--gray-50: #f9fafb;
				--gray-100: #f3f4f6;
				--gray-200: #e5e7eb;
				--gray-300: #d1d5db;
				--gray-400: #9ca3af;
				--gray-500: #6b7280;
				--gray-600: #4b5563;
				--gray-700: #374151;
				--gray-800: #1f2937;
				--gray-900: #111827;

				--gradient-main: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				--gradient-accent: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
				--gradient-success: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);

				--shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
				--shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
				--shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
					0 2px 4px -2px rgb(0 0 0 / 0.1);
				--shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1),
					0 4px 6px -4px rgb(0 0 0 / 0.1);
				--shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1),
					0 8px 10px -6px rgb(0 0 0 / 0.1);

				--radius-sm: 0.375rem;
				--radius: 0.5rem;
				--radius-md: 0.75rem;
				--radius-lg: 1rem;
				--radius-xl: 1.5rem;
			}

			body {
				font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
				line-height: 1.6;
				color: var(--gray-800);
				background: var(--gray-50);
				overflow-x: hidden;
			}

			/* 索引页面 */
			.landing-page {
				min-height: 100vh;
				background: var(--gradient-main);
				position: relative;
			}

			.landing-page::before {
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
				opacity: 0.6;
			}

			.landing-container {
				position: relative;
				z-index: 1;
				max-width: 1200px;
				margin: 0 auto;
				padding: 2rem;
			}

			/* Hero 区域 */
			.hero {
				text-align: center;
				padding: 4rem 0 6rem;
				color: white;
			}

			.hero-title {
				font-size: 3.5rem;
				font-weight: 800;
				margin-bottom: 1.5rem;
				background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				line-height: 1.1;
			}

			.hero-subtitle {
				font-size: 1.5rem;
				font-weight: 500;
				margin-bottom: 1rem;
				opacity: 0.95;
			}

			.hero-description {
				font-size: 1.125rem;
				margin-bottom: 3rem;
				opacity: 0.85;
				max-width: 600px;
				margin-left: auto;
				margin-right: auto;
			}

			.hero-cta {
				display: inline-flex;
				align-items: center;
				gap: 0.75rem;
				background: rgba(255, 255, 255, 0.15);
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.2);
				color: white;
				padding: 1rem 2rem;
				border-radius: var(--radius-xl);
				font-size: 1.125rem;
				font-weight: 600;
				text-decoration: none;
				transition: all 0.3s ease;
				cursor: pointer;
			}

			.hero-cta:hover {
				background: rgba(255, 255, 255, 0.25);
				transform: translateY(-2px);
				box-shadow: var(--shadow-xl);
			}

			/* 功能卡片区域 */
			.features {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
				gap: 2rem;
				margin-bottom: 4rem;
			}

			.feature-card {
				background: rgba(255, 255, 255, 0.1);
				backdrop-filter: blur(15px);
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: var(--radius-xl);
				padding: 2.5rem;
				text-align: center;
				color: white;
				transition: all 0.3s ease;
				cursor: pointer;
				position: relative;
				overflow: hidden;
			}

			.feature-card::before {
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: linear-gradient(
					135deg,
					rgba(255, 255, 255, 0.1) 0%,
					rgba(255, 255, 255, 0.05) 100%
				);
				opacity: 0;
				transition: opacity 0.3s ease;
			}

			.feature-card:hover {
				transform: translateY(-8px);
				box-shadow: var(--shadow-xl);
			}

			.feature-card:hover::before {
				opacity: 1;
			}

			.feature-icon {
				font-size: 4rem;
				margin-bottom: 1.5rem;
				display: block;
				position: relative;
				z-index: 1;
			}

			.feature-title {
				font-size: 1.5rem;
				font-weight: 700;
				margin-bottom: 1rem;
				position: relative;
				z-index: 1;
			}

			.feature-desc {
				font-size: 1rem;
				opacity: 0.9;
				line-height: 1.6;
				position: relative;
				z-index: 1;
			}

			/* 步骤说明 */
			.steps {
				background: white;
				border-radius: var(--radius-xl);
				padding: 3rem;
				margin: 4rem 0;
				box-shadow: var(--shadow-lg);
			}

			.steps-title {
				text-align: center;
				font-size: 2.5rem;
				font-weight: 700;
				color: var(--gray-800);
				margin-bottom: 3rem;
			}

			.steps-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
				gap: 3rem;
			}

			.step-item {
				text-align: center;
				position: relative;
			}

			.step-number {
				width: 80px;
				height: 80px;
				border-radius: 50%;
				background: var(--gradient-main);
				color: white;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 2rem;
				font-weight: 700;
				margin: 0 auto 1.5rem;
				box-shadow: var(--shadow-lg);
				position: relative;
			}

			.step-title {
				font-size: 1.25rem;
				font-weight: 600;
				color: var(--gray-800);
				margin-bottom: 0.75rem;
			}

			.step-desc {
				color: var(--gray-600);
				line-height: 1.6;
			}

			/* API 文档区域 */
			.api-docs {
				background: white;
				border-radius: var(--radius-xl);
				padding: 3rem;
				margin: 4rem 0;
				box-shadow: var(--shadow-lg);
			}

			.api-title {
				text-align: center;
				font-size: 2.5rem;
				font-weight: 700;
				color: var(--gray-800);
				margin-bottom: 1rem;
			}

			.api-subtitle {
				text-align: center;
				font-size: 1.125rem;
				color: var(--gray-600);
				margin-bottom: 3rem;
			}

			.api-base {
				background: var(--gray-50);
				border: 1px solid var(--gray-200);
				border-radius: var(--radius);
				padding: 1.5rem;
				margin-bottom: 2rem;
				font-family: "Monaco", "Menlo", monospace;
			}

			.api-base-label {
				font-weight: 600;
				color: var(--gray-700);
				margin-bottom: 0.5rem;
			}

			.api-base-url {
				background: var(--primary);
				color: white;
				padding: 0.5rem 1rem;
				border-radius: var(--radius-sm);
				font-size: 0.875rem;
				word-break: break-all;
			}

			.endpoints {
				display: grid;
				gap: 1.5rem;
			}

			.endpoint {
				border: 1px solid var(--gray-200);
				border-radius: var(--radius-lg);
				overflow: hidden;
				transition: all 0.3s ease;
			}

			.endpoint:hover {
				border-color: var(--primary);
				box-shadow: var(--shadow-md);
			}

			.endpoint-header {
				background: var(--gray-50);
				padding: 1.5rem;
				border-bottom: 1px solid var(--gray-200);
			}

			.endpoint-method {
				display: inline-flex;
				align-items: center;
				gap: 1rem;
				margin-bottom: 0.75rem;
			}

			.method-badge {
				background: var(--success);
				color: white;
				padding: 0.25rem 0.75rem;
				border-radius: var(--radius-sm);
				font-family: "Monaco", "Menlo", monospace;
				font-size: 0.875rem;
				font-weight: 600;
			}

			.endpoint-path {
				font-family: "Monaco", "Menlo", monospace;
				font-weight: 600;
				color: var(--gray-700);
			}

			.endpoint-desc {
				color: var(--gray-600);
			}

			.endpoint-body {
				padding: 1.5rem;
			}

			.code-example {
				background: var(--gray-900);
				color: var(--gray-100);
				border-radius: var(--radius);
				padding: 1.5rem;
				font-family: "Monaco", "Menlo", monospace;
				font-size: 0.875rem;
				overflow-x: auto;
				position: relative;
			}

			.copy-btn {
				position: absolute;
				top: 1rem;
				right: 1rem;
				background: var(--gray-700);
				color: white;
				border: none;
				padding: 0.5rem;
				border-radius: var(--radius-sm);
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.copy-btn:hover {
				background: var(--gray-600);
			}

			/* 应用页面 */
			.app-page {
				display: none;
				min-height: 100vh;
				background: var(--gray-50);
			}

			.app-header {
				background: white;
				border-bottom: 1px solid var(--gray-200);
				padding: 1rem 0;
				position: sticky;
				top: 0;
				z-index: 100;
				box-shadow: var(--shadow-sm);
			}

			.header-container {
				max-width: 1200px;
				margin: 0 auto;
				padding: 0 2rem;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.app-logo {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				font-size: 1.5rem;
				font-weight: 700;
				color: var(--primary);
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.app-logo:hover {
				color: var(--primary-dark);
			}

			.status-indicator {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.5rem 1rem;
				border-radius: var(--radius-xl);
				font-size: 0.875rem;
				font-weight: 500;
			}

			.status-online {
				background: rgba(16, 185, 129, 0.1);
				color: var(--success);
			}

			.status-offline {
				background: rgba(239, 68, 68, 0.1);
				color: var(--error);
			}

			.app-main {
				max-width: 1200px;
				margin: 0 auto;
				padding: 2rem;
			}

			.learning-tabs {
				display: flex;
				gap: 0.5rem;
				margin-bottom: 2rem;
				background: white;
				padding: 0.5rem;
				border-radius: var(--radius-lg);
				box-shadow: var(--shadow-sm);
			}

			.tab-button {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.75rem 1.5rem;
				border: none;
				background: transparent;
				border-radius: var(--radius);
				cursor: pointer;
				transition: all 0.3s ease;
				font-weight: 500;
				color: var(--gray-600);
				flex: 1;
				justify-content: center;
			}

			.tab-button.active {
				background: var(--primary);
				color: white;
				box-shadow: var(--shadow-sm);
			}

			.tab-button:hover:not(.active) {
				background: var(--gray-100);
				color: var(--gray-800);
			}

			.content-card {
				background: white;
				border-radius: var(--radius-xl);
				padding: 2rem;
				box-shadow: var(--shadow-lg);
				border: 1px solid var(--gray-200);
			}

			.content-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 2rem;
				padding-bottom: 1rem;
				border-bottom: 1px solid var(--gray-200);
			}

			.content-type {
				font-size: 1.5rem;
				font-weight: 700;
				color: var(--gray-800);
			}

			.header-actions {
				display: flex;
				gap: 0.75rem;
			}

			.action-btn {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.75rem 1rem;
				border: 1px solid var(--gray-300);
				background: white;
				border-radius: var(--radius);
				cursor: pointer;
				transition: all 0.3s ease;
				font-weight: 500;
				font-size: 0.875rem;
			}

			.action-btn:hover:not(:disabled) {
				border-color: var(--primary);
				color: var(--primary);
				transform: translateY(-1px);
				box-shadow: var(--shadow-sm);
			}

			.action-btn:disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}

			.action-btn.speak {
				border-color: var(--success);
				color: var(--success);
			}

			.action-btn.speak.speaking {
				background: var(--error);
				border-color: var(--error);
				color: white;
			}

			.content-main {
				font-size: 1.75rem;
				line-height: 1.6;
				color: var(--gray-800);
				margin-bottom: 1.5rem;
				font-weight: 500;
			}

			.content-interpretation {
				background: var(--gray-50);
				border: 1px solid var(--gray-200);
				border-left: 4px solid var(--primary);
				border-radius: var(--radius);
				padding: 1.5rem;
				margin-bottom: 1.5rem;
			}

			.keywords-section {
				margin-top: 1.5rem;
			}

			.keywords-title {
				font-weight: 600;
				margin-bottom: 1rem;
				color: var(--gray-700);
			}

			.keywords-list {
				display: flex;
				flex-wrap: wrap;
				gap: 0.75rem;
			}

			.keyword-tag {
				background: var(--gradient-main);
				color: white;
				padding: 0.5rem 1rem;
				border-radius: var(--radius-xl);
				font-size: 0.875rem;
				font-weight: 500;
			}

			.loading {
				display: flex;
				justify-content: center;
				align-items: center;
				padding: 4rem;
				color: var(--gray-500);
			}

			.spinner {
				width: 40px;
				height: 40px;
				border: 3px solid var(--gray-200);
				border-left-color: var(--primary);
				border-radius: 50%;
				animation: spin 1s linear infinite;
				margin-right: 1rem;
			}

			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}

			.error-message {
				background: rgba(239, 68, 68, 0.1);
				border: 1px solid rgba(239, 68, 68, 0.2);
				color: var(--error);
				padding: 1.5rem;
				border-radius: var(--radius);
				text-align: center;
			}

			/* 响应式设计 */
			@media (max-width: 768px) {
				.hero-title {
					font-size: 2.5rem;
				}

				.hero-subtitle {
					font-size: 1.25rem;
				}

				.landing-container {
					padding: 1rem;
				}

				.features {
					grid-template-columns: 1fr;
					gap: 1rem;
				}

				.steps,
				.api-docs {
					padding: 2rem 1rem;
				}

				.steps-grid {
					grid-template-columns: 1fr;
					gap: 2rem;
				}

				.learning-tabs {
					flex-direction: column;
				}

				.header-container {
					flex-direction: column;
					gap: 1rem;
					padding: 0 1rem;
				}

				.app-main {
					padding: 1rem;
				}

				.content-header {
					flex-direction: column;
					gap: 1rem;
					align-items: stretch;
				}

				.header-actions {
					justify-content: center;
				}

				.content-main {
					font-size: 1.5rem;
				}
			}

			@media (max-width: 480px) {
				.hero-title {
					font-size: 2rem;
				}

				.feature-card {
					padding: 2rem;
				}

				.step-number {
					width: 60px;
					height: 60px;
					font-size: 1.5rem;
				}

				.action-btn {
					flex: 1;
				}
			}
		</style>
	</head>
	<body>
		<!-- 索引页面 -->
		<div id="landingPage" class="landing-page">
			<div class="landing-container">
				<!-- Hero 区域 -->
				<div class="hero">
					<h1 class="hero-title">📚 每日学习助手</h1>
					<p class="hero-subtitle">基于豆包大模型的智能学习推荐</p>
					<p class="hero-description">
						每天为你推送精选的英语谚语、中文古诗词和中医基础知识，让学习成为一种习惯
					</p>
					<button class="hero-cta" onclick="enterApp()">
						<i class="fas fa-rocket"></i>
						开始学习之旅
					</button>
				</div>

				<!-- 功能卡片 -->
				<div class="features">
					<div class="feature-card" onclick="Router.navigate('/app/english')">
						<span class="feature-icon">🇺🇸</span>
						<h3 class="feature-title">英语谚语</h3>
						<p class="feature-desc">
							传统谚语、格言、习语，提升英语理解能力和文化素养
						</p>
					</div>
					<div class="feature-card" onclick="Router.navigate('/app/chinese')">
						<span class="feature-icon">🇨🇳</span>
						<h3 class="feature-title">中文古诗词</h3>
						<p class="feature-desc">
							古诗、词、赋等传统文化瑰宝，传承中华文化精髓
						</p>
					</div>
					<div class="feature-card" onclick="Router.navigate('/app/tcm')">
						<span class="feature-icon">🌿</span>
						<h3 class="feature-title">中医基础</h3>
						<p class="feature-desc">
							《黄帝内经》、《伤寒论》等经典条文，了解中医理论和基础知识
						</p>
					</div>
				</div>

				<!-- 使用步骤 -->
				<div class="steps">
					<h2 class="steps-title">🚀 如何使用</h2>
					<div class="steps-grid">
						<div class="step-item">
							<div class="step-number">1</div>
							<h3 class="step-title">选择学习类型</h3>
							<p class="step-desc">
								从英语谚语、中文古诗词、中医基础中选择你感兴趣的内容
							</p>
						</div>
						<div class="step-item">
							<div class="step-number">2</div>
							<h3 class="step-title">获取今日内容</h3>
							<p class="step-desc">
								AI会为你推荐今天的学习内容，包含详细解释和关键词
							</p>
						</div>
						<div class="step-item">
							<div class="step-number">3</div>
							<h3 class="step-title">学习与记录</h3>
							<p class="step-desc">系统会自动记录你的学习历史，避免重复推荐</p>
						</div>
					</div>
				</div>

				<!-- API 文档 -->
				<div class="api-docs">
					<h2 class="api-title">🛠 开发者接口</h2>
					<p class="api-subtitle">开放的 API 接口，支持集成到你的应用中</p>

					<div class="api-base">
						<div class="api-base-label">API 基础地址</div>
						<div class="api-base-url">
							https://everyday-study-backend.onrender.com/api
						</div>
					</div>

					<div class="endpoints">
						<div class="endpoint">
							<div class="endpoint-header">
								<div class="endpoint-method">
									<span class="method-badge">GET</span>
									<span class="endpoint-path">/today-learning/{type}</span>
								</div>
								<p class="endpoint-desc">
									获取今日学习内容 (english, chinese, tcm)
								</p>
							</div>
							<div class="endpoint-body">
								<div class="code-example">
									<button
										class="copy-btn"
										onclick="copyToClipboard('curl https://everyday-study-backend.onrender.com/api/today-learning/english')"
									>
										<i class="fas fa-copy"></i>
									</button>
									<pre>
curl https://everyday-study-backend.onrender.com/api/today-learning/english</pre
									>
								</div>
							</div>
						</div>

						<div class="endpoint">
							<div class="endpoint-header">
								<div class="endpoint-method">
									<span class="method-badge">GET</span>
									<span class="endpoint-path">/health</span>
								</div>
								<p class="endpoint-desc">检查服务健康状态</p>
							</div>
							<div class="endpoint-body">
								<div class="code-example">
									<button
										class="copy-btn"
										onclick="copyToClipboard('curl https://everyday-study-backend.onrender.com/api/health')"
									>
										<i class="fas fa-copy"></i>
									</button>
									<pre>
curl https://everyday-study-backend.onrender.com/api/health</pre
									>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 应用页面 -->
		<div id="appPage" class="app-page">
			<header class="app-header">
				<div class="header-container">
					<div class="app-logo" onclick="goHome()">
						<i class="fas fa-graduation-cap"></i>
						每日学习助手
					</div>
					<div id="statusIndicator" class="status-indicator">
						<i class="fas fa-circle"></i>
						<span>检查中...</span>
					</div>
				</div>
			</header>

			<main class="app-main">
				<div class="learning-tabs">
					<button class="tab-button active" data-type="english">
						<i class="fas fa-globe-americas"></i>
						英语谚语
					</button>
					<button class="tab-button" data-type="chinese">
						<i class="fas fa-yin-yang"></i>
						中文古诗词
					</button>
					<button class="tab-button" data-type="tcm">
						<i class="fas fa-leaf"></i>
						中医基础
					</button>
				</div>

				<div class="content-card">
					<div class="content-header">
						<div class="content-type" id="contentType">英语谚语</div>
						<div class="header-actions">
							<button
								class="action-btn speak"
								id="speakBtn"
								onclick="toggleSpeech()"
								style="display: none"
							>
								<i class="fas fa-volume-up"></i> 朗读
							</button>
							<button
								class="action-btn"
								id="refreshBtn"
								onclick="loadContent(true)"
							>
								<i class="fas fa-sync-alt"></i> 刷新
							</button>
						</div>
					</div>

					<div id="contentContainer">
						<div class="loading">
							<div class="spinner"></div>
							正在加载内容...
						</div>
					</div>
				</div>
			</main>
		</div>

		<script>
			const API_BASE = "https://everyday-study-backend.onrender.com/api";
			let currentType = "english";
			let isLoading = false;

			const typeNames = {
				english: "英语谚语",
				chinese: "中文古诗词",
				tcm: "中医基础",
			};

			const typeIcons = {
				english: "🇺🇸",
				chinese: "🇨🇳",
				tcm: "🌿",
			};

			// 本地缓存管理
			const CacheManager = {
				getTodayKey() {
					return new Date().toISOString().split("T")[0];
				},

				getCacheKey(type) {
					return `learning_content_${type}`;
				},

				saveContent(type, content) {
					try {
						const cacheData = {
							content: content,
							date: this.getTodayKey(),
							timestamp: Date.now(),
						};
						localStorage.setItem(
							this.getCacheKey(type),
							JSON.stringify(cacheData)
						);
					} catch (error) {
						console.warn("保存缓存失败:", error);
					}
				},

				getContent(type) {
					try {
						const cached = localStorage.getItem(this.getCacheKey(type));
						if (!cached) return null;

						const cacheData = JSON.parse(cached);
						const today = this.getTodayKey();

						if (cacheData.date === today) {
							return cacheData.content;
						} else {
							this.clearContent(type);
							return null;
						}
					} catch (error) {
						console.warn("读取缓存失败:", error);
						return null;
					}
				},

				clearContent(type) {
					try {
						localStorage.removeItem(this.getCacheKey(type));
					} catch (error) {
						console.warn("清除缓存失败:", error);
					}
				},

				clearExpiredCache() {
					const today = this.getTodayKey();
					["english", "chinese", "tcm"].forEach((type) => {
						try {
							const cached = localStorage.getItem(this.getCacheKey(type));
							if (cached) {
								const cacheData = JSON.parse(cached);
								if (cacheData.date !== today) {
									this.clearContent(type);
								}
							}
						} catch (error) {
							console.warn(`清除 ${type} 过期缓存失败:`, error);
						}
					});
				},
			};

			// 语音合成管理器
			const SpeechManager = {
				synthesis: window.speechSynthesis,
				currentUtterance: null,
				isSupported: "speechSynthesis" in window,

				init() {
					if (!this.isSupported) {
						console.warn("浏览器不支持语音合成功能");
						return false;
					}
					return true;
				},

				speak(text, lang = "en-US") {
					if (!this.isSupported) {
						alert("您的浏览器不支持语音朗读功能");
						return;
					}

					this.stop();

					const utterance = new SpeechSynthesisUtterance(text);
					utterance.lang = lang;
					utterance.rate = 0.8;
					utterance.pitch = 1.0;
					utterance.volume = 1.0;

					utterance.onstart = () => {
						this.updateSpeakButton(true);
					};

					utterance.onend = () => {
						this.updateSpeakButton(false);
						this.currentUtterance = null;
					};

					utterance.onerror = (error) => {
						console.error("语音合成错误:", error);
						this.updateSpeakButton(false);
						this.currentUtterance = null;
					};

					this.currentUtterance = utterance;
					this.synthesis.speak(utterance);
				},

				stop() {
					if (this.synthesis.speaking) {
						this.synthesis.cancel();
					}
					this.updateSpeakButton(false);
					this.currentUtterance = null;
				},

				toggle(text, lang = "en-US") {
					if (this.synthesis.speaking) {
						this.stop();
					} else {
						this.speak(text, lang);
					}
				},

				updateSpeakButton(isSpeaking) {
					const speakBtn = document.getElementById("speakBtn");
					if (!speakBtn) return;

					if (isSpeaking) {
						speakBtn.classList.add("speaking");
						speakBtn.innerHTML = '<i class="fas fa-stop"></i> 停止';
					} else {
						speakBtn.classList.remove("speaking");
						speakBtn.innerHTML = '<i class="fas fa-volume-up"></i> 朗读';
					}
				},
			};

			// 路由管理器
			const Router = {
				getCurrentRoute() {
					return window.location.hash.slice(1) || "/";
				},

				navigate(path) {
					window.location.hash = path;
				},

				parseRoute(route) {
					const parts = route.split("/").filter(Boolean);
					return {
						page: parts[0] || "home",
						type: parts[1] || "english",
					};
				},

				handleRoute() {
					const route = this.getCurrentRoute();
					const { page, type } = this.parseRoute(route);

					if (page === "app") {
						this.showAppPage(type);
					} else {
						this.showHomePage();
					}
				},

				showHomePage() {
					document.getElementById("landingPage").style.display = "block";
					document.getElementById("appPage").style.display = "none";
					document.title = "每日学习助手 - AI 智能学习内容推荐";
				},

				showAppPage(type = "english") {
					document.getElementById("landingPage").style.display = "none";
					document.getElementById("appPage").style.display = "block";
					document.title = `${typeNames[type]} - 每日学习助手`;

					if (currentType !== type) {
						currentType = type;
						this.updateActiveTab(type);
						document.getElementById("contentType").textContent =
							typeNames[type];
					}

					if (!window.apiHealthChecked) {
						checkApiHealth();
						window.apiHealthChecked = true;
					}

					loadContent();
				},

				updateActiveTab(type) {
					document.querySelectorAll(".tab-button").forEach((btn) => {
						btn.classList.remove("active");
					});
					const activeBtn = document.querySelector(`[data-type="${type}"]`);
					if (activeBtn) {
						activeBtn.classList.add("active");
					}
				},

				init() {
					window.addEventListener("hashchange", () => {
						this.handleRoute();
					});

					this.handleRoute();
				},
			};

			// 进入应用
			function enterApp() {
				Router.navigate("/app/english");
			}

			// 返回首页
			function goHome() {
				Router.navigate("/");
			}

			// 切换学习类型
			function switchType(type) {
				Router.navigate(`/app/${type}`);
			}

			// 检查 API 健康状态
			async function checkApiHealth() {
				const statusIndicator = document.getElementById("statusIndicator");

				try {
					const response = await fetch(`${API_BASE}/health`);
					const data = await response.json();

					if (data.success) {
						statusIndicator.className = "status-indicator status-online";
						statusIndicator.innerHTML =
							'<i class="fas fa-circle"></i><span>服务正常</span>';
					} else {
						throw new Error("API 返回错误");
					}
				} catch (error) {
					statusIndicator.className = "status-indicator status-offline";
					statusIndicator.innerHTML =
						'<i class="fas fa-circle"></i><span>服务异常</span>';
					console.error("健康检查失败:", error);
				}
			}

			// 加载学习内容
			async function loadContent(forceRefresh = false) {
				const refreshBtn = document.getElementById("refreshBtn");
				const contentContainer = document.getElementById("contentContainer");

				if (!forceRefresh) {
					const cachedContent = CacheManager.getContent(currentType);
					if (cachedContent) {
						console.log(`使用本地缓存的${typeNames[currentType]}内容`);
						cachedContent.from_cache = true;
						displayContent(cachedContent);
						return;
					}
				}

				if (isLoading) {
					console.log("正在加载中，跳过重复请求");
					return;
				}

				isLoading = true;

				refreshBtn.disabled = true;
				refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中';

				contentContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    正在加载今日${typeNames[currentType]}...
                </div>
            `;

				let retryCount = 0;
				const maxRetries = 3;

				const attemptLoad = async () => {
					try {
						const response = await fetch(
							`${API_BASE}/today-learning/${currentType}`
						);

						if (!response.ok) {
							throw new Error(
								`服务器响应错误: ${response.status} ${response.statusText}`
							);
						}

						const data = await response.json();

						if (data.success) {
							CacheManager.saveContent(currentType, data.data);
							displayContent(data.data);
							console.log(`从服务器获取${typeNames[currentType]}内容`);
						} else {
							throw new Error(data.message || "获取内容失败");
						}
					} catch (error) {
						console.error(
							`加载失败 (尝试 ${retryCount + 1}/${maxRetries}):`,
							error
						);

						if (retryCount < maxRetries - 1) {
							retryCount++;
							contentContainer.innerHTML = `
                            <div class="loading">
                                <div class="spinner"></div>
                                加载失败，正在重试 (${retryCount}/${maxRetries})...
                            </div>
                        `;
							await new Promise((resolve) => setTimeout(resolve, 2000));
							return attemptLoad();
						} else {
							let errorMessage = error.message;

							if (error.message.includes("500")) {
								errorMessage = "服务器内部错误，AI处理可能遇到问题";
							} else if (
								error.message.includes("timeout") ||
								error.message.includes("fetch")
							) {
								errorMessage = "网络连接超时，请检查网络连接";
							}

							contentContainer.innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div style="margin-bottom: 0.5rem;"><strong>加载失败</strong></div>
                                <div style="margin-bottom: 1rem;">${errorMessage}</div>
                                <button onclick="loadContent(true)" style="
                                    background: var(--primary);
                                    color: white;
                                    border: none;
                                    padding: 0.5rem 1rem;
                                    border-radius: var(--radius);
                                    cursor: pointer;
                                ">
                                    <i class="fas fa-redo"></i> 重新加载
                                </button>
                            </div>
                        `;
							throw error;
						}
					}
				};

				try {
					await attemptLoad();
				} catch (error) {
					// 最终错误处理已在 attemptLoad 中完成
				} finally {
					isLoading = false;
					refreshBtn.disabled = false;
					refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 刷新';
				}
			}

			// 显示学习内容
			function displayContent(content) {
				const contentContainer = document.getElementById("contentContainer");
				const speakBtn = document.getElementById("speakBtn");
				const typeIcon = typeIcons[content.type] || "📚";

				if (content.type === "english") {
					speakBtn.style.display = "flex";
					window.currentEnglishContent = content.content;
					SpeechManager.stop();
				} else {
					speakBtn.style.display = "none";
					window.currentEnglishContent = null;
					SpeechManager.stop();
				}

				let contentHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                    <span style="font-size: 2rem; margin-right: 1rem;">${typeIcon}</span>
                    <span style="font-weight: 600; color: var(--gray-600);">今日内容</span>
                </div>
                <div class="content-main">${content.content}</div>
            `;

				if (content.interpretation) {
					contentHTML += `
                    <div class="content-interpretation">
                        <strong>释义：</strong>${content.interpretation}
                    </div>
                `;
				}

				if (content.key_words && content.key_words.length > 0) {
					contentHTML += `
                    <div class="keywords-section">
                        <div class="keywords-title">关键词解析</div>
                        <div class="keywords-list">
                            ${content.key_words
															.map(
																(keyword) =>
																	`<span class="keyword-tag">${keyword}</span>`
															)
															.join("")}
                        </div>
                    </div>
                `;
				}

				contentContainer.innerHTML = contentHTML;
			}

			// 全局朗读函数
			function toggleSpeech() {
				const content = window.currentEnglishContent;
				if (content) {
					SpeechManager.toggle(content);
				}
			}

			// 复制到剪贴板功能
			function copyToClipboard(text) {
				navigator.clipboard
					.writeText(text)
					.then(() => {
						const btn = event.target.closest(".copy-btn");
						const originalText = btn.innerHTML;
						btn.innerHTML = '<i class="fas fa-check"></i>';
						setTimeout(() => {
							btn.innerHTML = originalText;
						}, 2000);
					})
					.catch((err) => {
						console.error("复制失败:", err);
					});
			}

			// 绑定标签页切换事件
			document.querySelectorAll(".tab-button").forEach((button) => {
				button.addEventListener("click", () => {
					const type = button.dataset.type;
					switchType(type);
				});
			});

			// 定期检查服务状态
			setInterval(checkApiHealth, 30000);

			// 页面加载完成后的初始化
			document.addEventListener("DOMContentLoaded", () => {
				CacheManager.clearExpiredCache();
				SpeechManager.init();
				Router.init();
				console.log("每日学习助手已加载完成");
			});
		</script>
	</body>
</html>
